#!/bin/sh -efu

charset="koi8-r"
fig_lang="ru_RU.KOI8-R"

verbose="${verbose-}"
verbose(){
  [ -z "$verbose" ] || printf "%s" "$*" > /dev/stderr
}

##################################################

PROG="${0##*/}"

show_help()
{
	cat <<EOF

$PROG - update html, marks and thumbnail for an image

Usage: $PROG [options] file

Options:
    -h,         display help screen
    -v,         be more verbose
    -t <title>  set image title
    -p <url>    url for "previous" reference
    -u <url>    url for "up" reference
    -n <url>    url for "next" reference
    -m <style>  style of gif marks

Input files:
  name.{jpg,png,tiff,gif}  -- sourse image
  name.fig                 -- marks in fig format

Generated files:
  _name.{jpg,png,tiff,gif} -- thumbnail
  name_m.gif or name_m.png -- marks
  name.htm                 -- html

Mark styles:
  simple_gif
  aa_gif
  aa_gif_halo
  aa_gif_dark_halo

Report bugs to <slazav@altlinux.org>
EOF
exit
}

##################################################

opts="hvt:p:u:n:m:"

TEMP=`getopt -n "$PROG" -o $opts -- "$@"` || show_help
eval set -- "$TEMP"

title=""
purl=""
uurl=""
nurl=""
mstyle="aa_gif"

while :; do
  case "$1" in
    -v) verbose=1 ;;
    -h) show_help ;;
    -t) title="$2"; shift ;;
    -p) purl="$2"; shift ;;
    -u) uurl="$2"; shift ;;
    -n) nurl="$2"; shift ;;
    -m) mstyle="$2"; shift ;;
    --) shift; break ;;
  esac
  shift
done

[ "$#" = 1 ] || show_help

ifile="$1"
[ -r "$ifile" ] || { printf "$ifile: can't find file\n"; exit 1; }

size="$(ph_size $ifile)"
width="${size%% *}"
height="${size##* }"

base="${1%.*}"

##################################################

print_exif2html(){
  eval "$(ph_exif "$1")"
  [ -z "${date:-}" ] ||
    printf "\n      Дата и время съемки: $date<br/>"
  [ -z "${geo_alt:-}"  ] ||
    printf "\n      Высота: %d м<br/>" "${geo_alt%.*}"
  [ -z "${geo_lat:-}" -o -z "${geo_lon:-}" ] ||
    printf "\n      Координаты: %.7f %.7f<br/>" "$geo_lat" "$geo_lon"
}

filter_text(){
  printf "%s" "$1" |
  sed -e '
    s/<[^>]*>//g
    s/<\|>//g
    s/[[:space:]]\+$//
    s/^[[:space:]]\+//
  '
}

th_mark(){
  mogrify -fill red -draw 'circle 10,10,12,12' "$1"
  exiv2 -c "<marked>" "$1" 2>/dev/null
}
th_marked(){
  [ -r "$1" ] || return 1
  [ "$(exiv2 -pc "$1" 2>/dev/null)" = "<marked>" ]
}

fig_im_size(){

  local ifile_q="$(printf %s "$ifile" |
    sed -e 's/[].*&^$[\/]/\\&/g')" ||:

  local fig="$base.fig"
  sed -n "
    /^[[:space:]]\+[0-9]\+[[:space:]]\+$ifile_q/!b; n
    s/^\([[:space:]]\+[0-9]\+\)\{4\}[[:space:]]\+\([0-9]\+\)[[:space:]]\+\([0-9]\+\).*/\2 \3/p; q
  " "$fig"
}

fig_scale(){
  local fig_size=$(fig_im_size)
  local fig_w="${fig_size%% *}"
  local fig_h="${fig_size##* }"
  local sc="$(printf "14.2875 / ( $fig_h/$height + $fig_w/$width ) * 2\n" | bc -l)" #"
  printf "%.3f\n" "$sc"
}

make_mark(){
  local halo="$1"; shift
  local base="$1"; shift
  local ifile="$1"; shift
  local mfile="$1"; shift

  verbose "  creating marks";
  gif_file="$(mktemp).gif"

  local sc="$(fig_scale)"
  [ "$mstyle" = "simple_gif" ] ||
    sc="$(printf "$sc*2\n" | bc -l)" ||:

  LANG="$fig_lang" fig2dev -m$sc -j -Lgif -D +0:200 -t'#FFFFFF' "$base.fig" "$gif_file"

  # IE can only show transparent gifs, not png. We can't use semi-transparent png here :(
  case "$mstyle" in
    simple_gif)
      mv -f -- "$gif_file" "$mfile"
    ;;
    aa_gif)
      convert\
        \( "$ifile"\
          \( "$gif_file" -alpha extract -blur 0x0.8 -threshold 15 -resize 50% \) \
          +matte -compose copy-opacity -composite -blur 0x2\
        \) \
        \( "$gif_file" -resize 50% \)\
        -compose over -composite\
        -quantize transparent \
        +dither -colors 255 -channel A -contrast-stretch 0\
        "$mfile"
    ;;
    aa_gif_halo)
      convert\
        \( "$ifile"\
          \( "$gif_file" -alpha extract -blur 0x1.2 -threshold 15 -resize 50% \) \
          +matte -compose copy-opacity -composite\
        \) \
        \( \
          "$gif_file"\
          \( -clone 0 +matte +level-colors white \
            \( -clone 0 -alpha extract -blur 4x3 -level 0%,50% \)\
            +matte -compose copy-opacity -composite \
          \) \
          -compose dst-over -composite\
          -resize 50%\
        \) \
        -compose over -composite\
        -quantize transparent \
        +dither -colors 255 -channel A -contrast-stretch 0\
        "$mfile"
    ;;
    aa_gif_dark_halo)
      convert\
        \( "$ifile"\
          \( "$gif_file" -alpha extract -blur 0x1.2 -threshold 15 -resize 50% \) \
          +matte -compose copy-opacity -composite\
        \) \
        \( \
          "$gif_file" +level 0,30%\
          \( -clone 0 +matte +level-colors white \
            \( -clone 0 -alpha extract -blur 4x3 -level 0%,50% \)\
            +matte -compose copy-opacity -composite \
          \) \
          -compose dst-over -composite\
          -resize 50%\
        \) \
        -compose over -composite\
        -quantize transparent \
        +dither -colors 255 -channel A -contrast-stretch 0\
        "$mfile"
    ;;
  esac
#  png_dark_halo
#  convert\
#        "$gif_file" +level 0,30%\
#        \( -clone 0 +matte +level-colors white \
#          \( -clone 0 -alpha extract -blur 4x3 -level 0%,50% \)\
#          +matte -compose copy-opacity -composite \
#        \) \
#        -compose dst-over -composite\
#        -resize 50%\
# "$mfile"

  rm -f -- "$gif_file"
}

verbose "$ifile";

## updating  marks
mfile=""
[ ! -r "$base.fig" ] || mfile="${base}_m.gif"
if [ -n "$mfile" -a "$mfile" -ot "$base.fig" ]; then
  make_mark "$mstyle" "$base" "$ifile" "$mfile"
fi

## removing old-style marks
if [ -f "$base.gif" -a "$base.gif" != "$ifile" ]; then
  echo "Removing old-style gif mark $base.gif" > /dev/stderr
  rm -f -- "$base.gif"
fi

## updating thumbnail
if [ "${ifile%/*}" != "$ifile" ]; then
  tfile="${ifile%/*}/_${ifile##*/}"
else
  tfile="_${ifile##*/}"
fi


# create thumbnail if image have change
if [ "$tfile" -ot "$ifile" ]; then
  verbose " creating thumbnail"
  ph_resize $ifile $tfile 200 100 600 1>&2
fi

if th_marked "$tfile"; then
  # remove marked thumbnail if we have no marks
  if [ -z "$mfile" ]; then
    verbose " removing marked thumbnail"
    ph_resize $ifile $tfile 200 100 600 1>&2
  fi
else
  if [ -n "$mfile" ]; then
    verbose "  updating mark on thumbnail"
    th_mark "$tfile"
  fi
fi

######################################################################
## creating html
verbose "  creating html";
alttitle="$(filter_text "$title")"


sty="a {text-decoration: none;}"
top=""
btm=""
scr=""

# make navigation panel
if [ -n "$purl" -o -n "$uurl" -o -n "$nurl" ]; then
  [ -z "$purl" ] || purl="<a href=\"$purl\">&lt;&lt; предыдущая</a>"
  [ -z "$uurl" ] || uurl="<a href=\"$uurl\">к оглавлению</a>"
  [ -z "$nurl" ] || nurl="<a href=\"$nurl\">следующая &gt;&gt;</a>"
  top="$top
    <table class=nav><tr>
      <td align=left>$purl</td>
      <td align=center>$uurl</td>
      <td align=right>$nurl</td>
    </tr></table>"
  sty="$sty
      .nav { font: bold 10pt sans-serif; width: 100%}"
fi

# make title
if [ -n "$title" ]; then
  btm="$btm
    <div class=title>$title</div>"
  sty="$sty
      .title { font: 16pt sans-serif;
               margin: 0px; padding-bottom: 20px;
               border-bottom: 1px solid #E0E0E0; width: 100%}"
fi

# make javascript for switching marks
image="
    <img src=\"${ifile##*/}\" width=\"$width\" height=\"$height\" alt=\"$alttitle\">"

if [ -n "$mfile" ]; then
  scr="$scr
    function update_vis(){
      document.getElementById(\"marks\").style.visibility=
        document.forms[0].elements[0].checked?'visible':'hidden'}
    function sw_marks(){
      document.forms[0].elements[0].checked=
        !document.forms[0].elements[0].checked}"

  sty="$sty
      #image { position: absolute; left: 0px; top: 0px; width: ${width}px; height: ${height}px; }
      #marks { position: absolute; left: 0px; top: 0px; width: ${width}px; visibility: visible; }
      .mrk { font: 8pt sans-serif; text-align: right; }"
  btm="$btm
    <table align=right class=mrk><tr><td><form>для переключения подписей щелкните мышью по картинке
      <input type=\"checkbox\" checked onclick=\"update_vis()\"></form></td></tr></table>"
  image="
      <div style=\"position: relative; height: ${height}px;\" onclick=\"sw_marks(); update_vis()\">
        <img id=\"image\" src=\"${ifile##*/}\" alt=\"$alttitle\">
        <img id=\"marks\" src=\"${mfile##*/}\">
      </div>"
fi

# make exif info
btm="$btm
    <div class=exif>$(print_exif2html "$ifile")
    </div>"
sty="$sty
      .exif { font: bold 8pt sans-serif;}"


if [ -n "$sty" ]; then
  sty="
    <style type=\"TEXT/CSS\">$sty
    </style>"
fi

if [ -n "$scr" ]; then
  scr="
    <script language=\"JavaScript\">$scr
    </script>"
fi

cat > $base.htm << EOF
<html>
  <head><title>$alttitle</title>
    <meta http-equiv="Content-Type" content="text/html;
          charset=$charset"/>$scr$sty
  </head>
  <body bgcolor="#FFFFFF">$top
    <div style="overflow:auto; margin: 5px">$image
    </div>$btm
  </body>
</html>
EOF
