H0(`addphoto -- набор скриптов для создания фотоальбомов')

<p><b>Исходный код на github:
<a href="https://github.com/slazav/ph_scripts">
https://github.com/slazav/ph_scripts</a></b>

<h3>Что это такое и как это работает</h3>

<p>Задача: упростить создание html-страниц с фотографиями. Хочется
писать текст с простейшей html-разметкой и в нужном месте написать
команду: "вставить сюда такую-то фотографию с такой-то подписью". Затем
прогнать файл через некий фильтр, который выполнит эти команды. addphoto
как раз и является таким фильтром.

<p>Возможности:

<ul>
<li>Вставка фотографий в html-страницу. На странице располагаются
уменьшенные картинки с подписями, которые могут быть сгруппированы
в горизонтальные таблицы или появляться сбоку от текста. Для каждой картинки
также создается отдельная html-страница с подписью, информацией о фотографии
(дата и время, координаты и высота), со ссылками на соседние фотографии и
обратно на страницу.

<li>Пометки на фотографиях. Можно наносить различные подписи и пометки
непосредственно на фотографию. Они создаются в виде векторного
графического файла в программе <a href="http://www.xfig.org">xfig</a> и
появляются на фотографии в виде отдельного прозрачного слоя. На главной
странице фотографии с пометками отмечаются красной точкой в углу
уменьшенной картинки.

<li>Оглавление. Можно создать заголовки с помощью специальных команд,
и вставить автоматически созданное оглавление в любое место страницы.
</ul>

<p>Я использую эту систему уже много лет (года с 2004), за это время с
ее помощью было создано более 160 текстов с фотографиями, в основном
отчеты о походах. Внешний вид страниц задан довольно жестко, но
программы просты, и каждый сможет модифицировать их под свои задачи.
Кроме того, менять внешний вид можно средствами html в исходном файле.

<p>Примеры html-страниц, созданных с помощью этой программы (нестандартный
заголовок в исходом файле не относится к addphoto -- он обрабатывается еще
одним фильтром):

<ul>
<li><a href="http://slazav.mccme.ru/elbr09.htm">
            http://slazav.mccme.ru/elbr09.htm</a> --
   <a href="http://slazav.mccme.ru/elbr09.m4p">
   исходный файл для addphoto</a>;
<li><a href="http://slazav.mccme.ru/giss12.htm">
            http://slazav.mccme.ru/giss12.htm</a> --
   <a href="http://slazav.mccme.ru/giss12.m4p">
   исходный файл для addphoto</a>;
</ul>

<p>Для использования этих скриптов нужны следующие внешние программы: perl,
exiv2, ImageMagick (convert, identify). Если планируется использовать
пометки на фотографиях, нужны также программы xfig и transfig.


<hr><h3>С чего начать</h3>

<ul>

<li>Скопировать фотографии для фотоальбома в некоторую директорию,
например, album. Уменьшить фотографии, если надо. Это можно сделать
любым удобным способом, в частности так:
<br><tt><b>$ ph_resize -i album/*.jpg</b></tt>

<li>Создать заготовку для альбома:
<br><tt><b>$ addphoto_ini album</b></tt>
<br>При этом должны появиться файлы album.txt и album.htm, последний
можно открыть браузером и посмотреть, что поучилось.

<li>Редактировать album.txt, добавлять комментарии к фотографиям и
любой другой текст.

<li>Обновить альбом:
<br><tt><b>$ addphoto album.txt > album.htm</b></tt>

<li>Если некоторые фотографии были удалены из файла album.txt,
можно почистить альбом от соответствующих файлов:
<br><tt><b>$ addphoto_cleanup album</b></tt>
</ul>


<hr><h3>Структура фотоальбома и формат входного файла</h3>

<ul>
<li>фотографии для альбома живут в некоторой директории, например
<b>album</b>.


<li>Исходный файл живет рядом с этой директорией в файле с тем же именем,
например <b>album.txt</b> (расширение может быть любым).

<li>Созданный альбом попадает в файл <b>album.htm</b>. Можно использовать
разные промежуточные файлы и фильтры, однако конечный результат должен
оказаться в файле с таким именем, так как на него ссылаются страницы
фотографий.
</ul>

<p>В исходном файле, кроме произвольного html кода, который попадет в
альбом без изменений, могут встречаться следующие команды, начинающиеся
с новой строки:

<ul>
<li><b>\photo <i>&lt;название файла с картинкой&gt;</i> <i>&lt;комментарий к картинке&gt;</i></b>

<p>Вставить картинку. На главную страницу вставляется уменьшенная
картинка с подписью снизу. Ссылка с нее ведет на отдельный html-файл с
большой картинкой и различной информацией. Если такие строчки идут
подряд, картинки располагаются горизонтально. Если между такими
строчками появляется пустая строка или другой текст -- начинается новый
ряд.

<p>Картинки могут лежать в поддиректориях внутри album, в этом случае
в исходном файле следует указывать относительные пути, например
<tt>\photo day1/foto5.jpg</tt>. Использование в этом месте абсолютных
путей и путей с '..' запрещено.

<li><b>\photor <i>&lt;название файла с картинкой&gt;</i> <i>&lt;комментарий к картинке&gt;</i></b>
<br><b>\photol <i>&lt;название файла с картинкой&gt;</i> <i>&lt;комментарий к картинке&gt;</i></b>

<p>То же, но фотография встает справа или слева от текста.

<li><b>\h[1234] <i>&lt;текст&gt;</i></b>
<p>Заголовок 1..4 уровня, &lt;h1&gt; ... &lt;h4&gt;. Для таких
заголовков возможно создание оглавления командой \toc.

<li><b>\h[1234]r <i>&lt;текст&gt;</i></b>
<p>То же, но перед заголовком вставляется горизонтальная линейка.

<li><b>\toc</b>
<p>Создать оглавление со ссылками на все заголовки, находящиеся в файле.

<li><b>\end</b>
<p>Дальнейший текст не обрабатывается и в альбом не попадает.

<li><b>\#</b>
<p>Комментарий. Эта строка игнорируется.

<li><b>\\<i>&lt;любая строка&gt;</i></b>
Вставить символ '\' в начало строки.

<li><b>\keep <i>&lt;файл&gt;</i></b>
<p>Хранить файлы, не относящиеся напрямую к альбому. В имени файла можно
использовать маски с *, ?, {,}. Команда используется только при чистке
альбома от устаревших файлов (addphoto_cleanup). В обычном режиме эта
строка игнорируется.

</ul>

<p>Весь остальной текст копируется в фотоальбом без изменений.

<hr><h3>Пример входного файла</h3>
<pre><tt>
\# Использую простейший заголовок html:
&lt;html&gt;&lt;body&gt;
&lt;h2&gt;Отчет о походе в кабак, 10-12 июня 2012г&lt;/h2&gt;

\# оглавление, в него попадут остальные заголовки, заданные командами \h...
\# справа от оглавления поместим карту:
\photor map.png карта
\toc

\h4r День первый, 10 июня

&lt;p&gt;День не предвещал ничего особенного... Утром я вышел из дома
и направился ...

\photo 2310.jpg начало пути
\photo 2311.jpg
\photo 2312.jpg

\photo 2314.jpg
\photo 2313.jpg еще какой-то комментарий

\# -- тут на выходе получатся три фотографии в ряд, а под ними еще две

\h4 День второй, 11 июня

\photo 2315.jpg
\photo 2316.jpg

\h4 День третий, 12 июня

\photo 2317.jpg
\photo 2318.jpg мы достигли цели!

\h4 Выводы

&lt;p&gt;Вряд ли из всего этого можно извлечь какие-то выводы.
Так что поскорее заканчиваю этот текст!

&lt;/body&gt;&lt;/html&gt;
</tt></pre>


<hr><h3>Программы</h3>

<p>Тут приведены только наиболее обычные примеры вызова этих программ.
Все эти программы при запуске без аргументов или с параметром -h
показывают свое описание и более полный список параметров.

<ul>
<li><b>addphoto album.txt &gt; album.htm</b>

<p>Обновить оглавление фотоальбома, При необходимости обновить
html-страницы для фотографий, превьюшки, картинки с пометками...

<li><b>addphoto_cleanup album.txt</b>

<p>Удалить файлы, не относящиеся к данному фотоальбому. По умолчанию
показывается список таких файлов и спрашивается, нужно ли их удалять.
Используйте команду \keep, чтобы спасти файлы, лежащие в директории
album, но не относящиеся к addphoto, от удаления.

<li><b>addphoto_ini album</b>

<p>Создать заготовку фотоальбома с фотографиями из директории album.

<li><b>addphoto_mkfig image.jpg</b>

<p>Создать заготовку fig-файла для рисования пометок на фотографии.
Если файл уже есть, он не меняется. Удобно использовать совместно с
gqview, для этого добавить в .gqviewrc что-то вроде такого:
<br><tt>external_8: "fig" "file=%p; addphoto_mkfig $file; xfig ${file%.*}.fig &amp;"</tt>
<br>При такой настройке, при нажатии в gqview ctrl-8 откроется fig-файл
с фотографией, в котором можно будет рисовать пометки.

<li><b>addphoto_img image.jpg</b>

<p>Программа, используемая в addphoto. Создает или обновляет все
необходимые дополнительные файлы для данной картинки: уменьшенное
изображение, html-страницу, файл с пометками.

<li><b>ph_resize -s <i>&lt;S1&gt;:&lt;S2&gt;:&lt;S3&gt; &lt;in_image&gt; &lt;out_image&gt;</i></b>
<br><b>ph_resize -i -s <i>&lt;S1&gt;:&lt;S2&gt;:&lt;S3&gt; &lt;in_image1&gt &lt;in_image2&gt;</i> ...</b>

<p>Умное уменьшение картинки в соответствии с параметрами S1:S2:S3 (по
умолчанию 800:400:10000). Пропорция картинки всегда сохраняется, а новый размер
вычисляется по следующим правилам:
<ul>
<li>"oбычные" картинки вписываются в квадрат S1xS1 точек;
<li>"длинные" картинки уменьшаются до размера не менее S2 точек по короткой стороне;
<li>"очень длинные" картинки уменьшаются до размера не более S3 точек по длинной стороне;
<li>картинки, не требующие уменьшения, оставляются без изменений.
</ul>

<p>Без ключа -i получает два аргумента: имена входного и выходного
файлов. С ключом -i перемасштабирует все файлы, заданные в командной
строке, уменьшенные изображения записывается под старыми именами.
(Исходные изображения теряются!)

<p>В фотоальбомах, создваемых addphoto, размер больших картинок никак не
задан, вы сами можете уменьшить их с помощью ph_resize или как-то еще.
При изготовлении уменьшенных картинок используются параметры
200:120:600.

<li><b>ph_addgeo -t track.plt image1.jpg image2.jpg ...</b>
<p>Добавление геоданных в exif-данные фотографии (эти данные
использует addphoto при показе информации о фотографии).

<p>Координаты и высота фотографий берутся из трека (в формате
OziExplorer), если он задан опцией -t. Важно, чтобы часы на
фотоаппарате были синхронизированы с gps (если это не так, время можно
сдвинуть опцией -s). Данные трека линейно интерполируются, при этом
можно установить ограничения на максимальный диапазон интерполяции по
времени (-M) и по расстоянию (-D).

<p>Кроме того, данные берутся из файла .geodata.txt. Данные из файла
имеют приоритет. Это нужно, чтобы можно было исправить неправильные
координаты у отдельных фотографий.

<p>Координаты записываются в exif-данные фотографий, кроме того,
записывается обновленный файл .geodata.txt. Для проверки записывается
также wpt-файл с точками съемки.

<p>(Возможно, поведение этого скрипта следует упростить.)

</ul>


<hr><h3>Известные проблемы</h3>

<p>Белые пометки на фотографиях исчезают, поскольку белый цвет используется
в качестве фона и становится прозрачным.

<p>addphoto_ini упорядочивает фотографии в альбоме по имени. Возможно,
следует сделать возможность упорядочивать их по времени.



<p>Замечания шлите на slazav<zza>@<uuu1>altlinux.org


